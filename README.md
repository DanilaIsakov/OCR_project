# Проект распознавания рукописного русского текста

Проект для распознавания рукописного русского текста на основе специализированной модели **cyrillic-trocr/trocr-handwritten-cyrillic** - TrOCR модели, специально обученной для кириллического рукописного текста.

## Структура проекта

```
OCR_project/
├── images/          # Папка с изображениями рукописного текста
├── writings/        # Папка с расшифровками (ground truth) для каждого изображения
├── dataset.py       # Класс для загрузки и обработки датасета
├── segment_lines.py # Модуль для сегментации изображений по строкам
├── recognize.py     # Скрипт для распознавания с готовыми моделями (РЕКОМЕНДУЕТСЯ)
├── config.py        # Конфигурация проекта
├── requirements.txt # Зависимости проекта
└── README.md        # Документация проекта
```

## Установка

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Установите Kraken для сегментации строк (без зависимостей, для совместимости с PyTorch 2.x):
```bash
pip install kraken --no-deps
```

3. Убедитесь, что у вас установлен PyTorch (с поддержкой CUDA, если доступна видеокарта):
```bash
# Для CPU
pip install torch torchvision

# Для CUDA (пример для CUDA 11.8)
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
```

**Примечание:** Kraken устанавливается с флагом `--no-deps`, так как он требует PyTorch <1.11, а проект использует PyTorch 2.x. Модуль `pageseg` работает с PyTorch 2.x без проблем.

## Использование готовых моделей

**Рекомендуется использовать готовые модели, если у вас недостаточно данных для обучения!**

Простой скрипт `recognize.py` позволяет использовать несколько готовых моделей:

### Распознавание с помощью TrOCR Cyrillic (РЕКОМЕНДУЕТСЯ для русского рукописного текста)

Специализированная модель `cyrillic-trocr/trocr-handwritten-cyrillic` специально обучена для кириллического рукописного текста и дает лучшие результаты.

**Важно:** По умолчанию изображения автоматически сегментируются на строки перед распознаванием для повышения точности:

```bash
# Одно изображение (по умолчанию используется trocr-cyrillic с сегментацией)
python recognize.py --image images/DSCN4528.JPG

# Или явно указать метод
python recognize.py --image images/DSCN4528.JPG --method trocr-cyrillic

# Пакетная обработка
python recognize.py --batch images/ --method trocr-cyrillic --output results.txt

# С использованием GPU (если доступно)
python recognize.py --image images/DSCN4528.JPG --method trocr-cyrillic --gpu

# Отключить сегментацию (распознавать все изображение целиком)
python recognize.py --image images/DSCN4528.JPG --method trocr-cyrillic --no-segment
```

**Примечание:** При первом запуске модель скачается автоматически (~500MB).

### Распознавание с помощью общей TrOCR модели

```bash
python recognize.py --image images/DSCN4528.JPG --method trocr
```

## Формат данных

- **Изображения**: JPG, PNG, JPEG файлы в папке `images/`
- **Расшифровки**: TXT файлы в папке `writings/` с тем же именем, что и соответствующее изображение

Пример:
- `images/DSCN4528.JPG` → `writings/DSCN4528.txt`

Каждый текстовый файл содержит полный текст, который написан на соответствующем изображении (несколько строк).

## Модель

Проект использует специализированную модель **[cyrillic-trocr/trocr-handwritten-cyrillic](https://huggingface.co/cyrillic-trocr/trocr-handwritten-cyrillic)** - TrOCR модель, специально обученную для распознавания кириллического рукописного текста. 

Эта модель основана на [TrOCR (Transformer-based OCR)](https://github.com/microsoft/unilm/tree/master/trocr) от Microsoft и дообучена на датасете кириллического рукописного текста, что обеспечивает лучшие результаты для русского языка по сравнению с общей моделью.

Модель можно использовать без дополнительного обучения или дообучить на ваших данных для улучшения результатов на специфическом почерке.

## Метрики

Во время обучения вычисляется CER (Character Error Rate) - процент ошибок на уровне символов. Модель сохраняется, если CER на валидационной выборке улучшается.

## Требования

- Python 3.8+
- PyTorch 2.0+
- Transformers 4.30+
- Pillow
- CUDA (опционально, для ускорения обучения)

## Выбор метода распознавания

### Для небольшого количества данных (рекомендуется)

**Используйте готовые модели без обучения:**

1. **TrOCR Cyrillic** (РЕКОМЕНДУЕТСЯ) - специализированная модель для кириллического рукописного текста
   ```bash
   python recognize.py --image images/DSCN4528.JPG --method trocr-cyrillic
   # или просто (по умолчанию):
   python recognize.py --image images/DSCN4528.JPG
   ```

2. **TrOCR** - общая модель для рукописного текста
   ```bash
   python recognize.py --image images/DSCN4528.JPG --method trocr
   ```

## Сегментация по строкам

Проект автоматически сегментирует изображения на отдельные строки перед распознаванием. Это значительно улучшает точность для многострочного рукописного текста.

**Как это работает:**
1. Используется Kraken с моделью blla для сегментации страницы на строки
2. Извлекаются отдельные изображения каждой строки
3. Каждая строка распознается отдельно моделью TrOCR
4. Результаты объединяются в финальный текст

**Метод сегментации:**
- Основной метод: Kraken с моделью blla (baseline detection) для сегментации строк
- Fallback: горизонтальная проекция с бинаризацией и морфологическими операциями (если Kraken недоступен)

**Отключение сегментации:**
Если нужно распознать все изображение целиком (без разделения на строки), используйте флаг `--no-segment`:
```bash
python recognize.py --image images/DSCN4528.JPG --no-segment
```

**Сохранение сегментированных строк:**
В процессе распознавания сегментированные строки автоматически сохраняются в папку `segmented_lines/`. Для каждого изображения создается отдельная подпапка с именем изображения, в которой сохраняются изображения отдельных строк:
```
segmented_lines/
  ├── DSCN4528/
  │   ├── line_0001.png
  │   ├── line_0002.png
  │   └── ...
  ├── DSCN4537/
  │   ├── line_0001.png
  │   └── ...
```
Это полезно для отладки и проверки качества сегментации.

## Примечания

- **Для небольшого датасета (10-20 изображений) настоятельно рекомендуется использовать готовую модель TrOCR Cyrillic (`--method trocr-cyrillic`)**
- Модель `cyrillic-trocr/trocr-handwritten-cyrillic` специально обучена для русского рукописного текста и дает лучшие результаты
- **Сегментация по строкам включена по умолчанию** и значительно улучшает качество распознавания многострочного текста
- Модели при первом запуске скачаются автоматически (~500MB)
- TrOCR модели требуют библиотеку transformers и PyTorch
- Для сегментации используется Kraken с моделью blla (устанавливается с флагом --no-deps для совместимости с PyTorch 2.x)

