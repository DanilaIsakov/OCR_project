# Проект распознавания рукописного русского текста

Проект для распознавания рукописного русского текста на основе специализированной модели **cyrillic-trocr/trocr-handwritten-cyrillic** - TrOCR модели, специально обученной для кириллического рукописного текста.

## Структура проекта

```
OCR_project/
├── images/          # Папка с изображениями рукописного текста
├── writings/        # Папка с расшифровками (ground truth) для каждого изображения
├── dataset.py       # Класс для загрузки и обработки датасета
├── segment_lines.py # Модуль для сегментации изображений по строкам
├── recognize.py     # Скрипт для распознавания с готовыми моделями (РЕКОМЕНДУЕТСЯ)
├── config.py        # Конфигурация проекта
├── requirements.txt # Зависимости проекта
└── README.md        # Документация проекта
```

## Установка

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Установите YOLOv8 для сегментации строк:
```bash
pip install ultralytics huggingface_hub
```

3. Убедитесь, что у вас установлен PyTorch (с поддержкой CUDA, если доступна видеокарта):
```bash
# Для CPU
pip install torch torchvision

# Для CUDA (пример для CUDA 11.8)
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
```

**Примечание:** Проект использует YOLOv8 с моделью `armvectores/yolov8n_handwritten_text_detection` для сегментации рукописного текста на строки. Модель автоматически загружается при первом использовании.

## Использование готовых моделей

**Рекомендуется использовать готовые модели, если у вас недостаточно данных для обучения!**

Простой скрипт `recognize.py` позволяет использовать несколько готовых моделей:

### Распознавание с помощью TrOCR Cyrillic

Специализированная модель `cyrillic-trocr/trocr-handwritten-cyrillic` специально обучена для кириллического рукописного текста и дает лучшие результаты.

**Важно:** По умолчанию изображения автоматически сегментируются на строки перед распознаванием для повышения точности:

```bash
# Одно изображение (по умолчанию используется trocr-cyrillic с сегментацией)
python recognize.py --image images/DSCN4528.JPG

# Или явно указать метод
python recognize.py --image images/DSCN4528.JPG --method trocr-cyrillic

# Пакетная обработка
python recognize.py --batch images/ --method trocr-cyrillic --output results.txt

# С использованием GPU (если доступно)
python recognize.py --image images/DSCN4528.JPG --method trocr-cyrillic --gpu

# Отключить сегментацию (распознавать все изображение целиком)
python recognize.py --image images/DSCN4528.JPG --method trocr-cyrillic --no-segment
```

**Примечание:** При первом запуске модель скачается автоматически (~500MB).

### Распознавание с помощью общей TrOCR модели

```bash
python recognize.py --image images/DSCN4528.JPG --method trocr
```

## Формат данных

- **Изображения**: JPG, PNG, JPEG файлы в папке `images/`
- **Расшифровки**: TXT файлы в папке `writings/` с тем же именем, что и соответствующее изображение

Пример:
- `images/DSCN4528.JPG` → `writings/DSCN4528.txt`

Каждый текстовый файл содержит полный текст, который написан на соответствующем изображении (несколько строк).

## Модель

Проект использует специализированную модель **[cyrillic-trocr/trocr-handwritten-cyrillic](https://huggingface.co/cyrillic-trocr/trocr-handwritten-cyrillic)** - TrOCR модель, специально обученную для распознавания кириллического рукописного текста. 

Эта модель основана на [TrOCR (Transformer-based OCR)](https://github.com/microsoft/unilm/tree/master/trocr) от Microsoft и дообучена на датасете кириллического рукописного текста, что обеспечивает лучшие результаты для русского языка по сравнению с общей моделью.

Модель можно использовать без дополнительного обучения или дообучить на ваших данных для улучшения результатов на специфическом почерке.

## Дообучение модели

Для дообучения модели на ваших данных используйте скрипт `finetune.py`. 

### Структура данных для дообучения

Данные должны быть организованы в папке `FineTuning`:
```
FineTuning/
├── train/          # Папка с обучающими изображениями
│   ├── test0.png
│   ├── test1.png
│   └── ...
├── test/           # Папка с тестовыми изображениями
│   ├── test0.png
│   └── ...
├── train.tsv       # TSV файл с парами (имя_изображения, текст) для обучения
└── test.tsv        # TSV файл с парами (имя_изображения, текст) для тестирования
```

Формат TSV файлов: каждая строка содержит имя изображения и текст, разделенные табуляцией:
```
test0.png	ибо
test1.png	осталось
test10.png	поле
```

### Запуск дообучения

```bash
# Базовое использование (с параметрами по умолчанию)
python finetune.py

# С указанием параметров
python finetune.py \
    --batch-size 8 \
    --learning-rate 5e-5 \
    --num-epochs 10 \
    --output-dir fine_tuned_model \
    --gpu

# С указанием базовой модели
python finetune.py \
    --base-model cyrillic-trocr/trocr-handwritten-cyrillic \
    --output-dir my_fine_tuned_model \
    --gpu
```

### Параметры дообучения

- `--base-model`: Базовая модель для дообучения (по умолчанию используется из config.py)
- `--output-dir`: Директория для сохранения дообученной модели (по умолчанию: `fine_tuned_model`)
- `--batch-size`: Размер батча для обучения (по умолчанию: 4)
- `--learning-rate`: Скорость обучения (по умолчанию: 5e-5)
- `--num-epochs`: Количество эпох (по умолчанию: 10)
- `--warmup-steps`: Количество шагов для warmup (по умолчанию: 100)
- `--max-length`: Максимальная длина последовательности (по умолчанию: 512)
- `--gpu`: Использовать GPU (если доступен)
- `--fine-tuning-dir`: Путь к папке FineTuning (по умолчанию: `FineTuning`)

### Использование дообученной модели

После дообучения модель сохраняется в указанной директории. Для использования дообученной модели:

```bash
python recognize.py \
    --image images/DSCN4528.JPG \
    --method trocr-cyrillic \
    --trocr-model fine_tuned_model \
    --gpu
```

## Метрики

Во время обучения вычисляется CER (Character Error Rate) - процент ошибок на уровне символов, и WER (Word Error Rate) - процент ошибок на уровне слов. Модель сохраняется, если WER на валидационной выборке улучшается.

## Требования

- Python 3.8+
- PyTorch 2.0+
- Transformers 4.30+
- Pillow
- CUDA (опционально, для ускорения обучения)

**Сохранение сегментированных строк:**
В процессе распознавания сегментированные строки автоматически сохраняются в папку `segmented_lines/`. Для каждого изображения создается отдельная подпапка с именем изображения, в которой сохраняются изображения отдельных строк:
```
segmented_lines/
  ├── DSCN4528/
  │   ├── line_0001.png
  │   ├── line_0002.png
  │   └── ...
  ├── DSCN4537/
  │   ├── line_0001.png
  │   └── ...
```